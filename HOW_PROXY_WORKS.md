# Как работает прокси для OpenAI API

## Схема работы

```
[Пользователь в РФ] 
    ↓ (запрос на генерацию)
[Ваш сервер (в РФ или любой стране)]
    ↓ (запрос через прокси)
[Прокси-сервер (в США/Европе - доступен OpenAI)]
    ↓ (запрос к OpenAI API)
[OpenAI API (api.openai.com)]
    ↓ (ответ с изображением)
[Прокси-сервер]
    ↓ (передает ответ)
[Ваш сервер]
    ↓ (отдает пользователю)
[Пользователь в РФ получает изображение]
```

## Важно

✅ **Пользователю НЕ нужен VPN** - он просто отправляет запрос на ваш сервер

✅ **Ваш сервер использует прокси** - все запросы к OpenAI идут через прокси-сервер в доступном регионе

✅ **Пользователь получает результат** - изображение приходит к нему через ваш сервер

## Настройка

### 1. Настройте прокси на вашем сервере

В `.env` файле на сервере добавьте:

```bash
OPENAI_API_KEY=sk-ваш_ключ_openai
IMAGE_GENERATION_PROVIDER=openai
OPENAI_PROXY=http://proxy-server.com:8080
```

### 2. Как это работает в коде

Когда пользователь нажимает "Сгенерировать":

1. **Frontend** отправляет запрос на ваш API: `POST /api/generate/image`
2. **Ваш сервер** получает запрос и вызывает `image_generation_service.generate_image()`
3. **Сервис** делает запрос к OpenAI API **через прокси**:
   ```python
   async with session.post(
       "https://api.openai.com/v1/images/generations",
       json=payload,
       headers=headers,
       proxy="http://proxy-server.com:8080"  # ← Прокси используется здесь
   ) as response:
   ```
4. **OpenAI API** видит запрос от прокси-сервера (в доступном регионе) и обрабатывает его
5. **Ответ** с URL изображения возвращается через прокси на ваш сервер
6. **Ваш сервер** отдает URL изображения пользователю

## Где получить прокси

### Вариант 1: Прокси-сервисы

- **Bright Data** (ранее Luminati) - https://brightdata.com
- **Smartproxy** - https://smartproxy.com
- **Oxylabs** - https://oxylabs.io
- **Proxy-Cheap** - https://proxy-cheap.com (бюджетный вариант)

### Вариант 2: Свой прокси на VPS

Если у вас есть VPS в США/Европе:

1. Установите прокси-сервер (Squid, 3proxy)
2. Настройте для HTTPS трафика
3. Используйте IP:порт вашего VPS

### Вариант 3: Cloudflare Workers (бесплатно)

Можно создать прокси через Cloudflare Workers - это бесплатно и работает быстро.

## Пример настройки

### В .env на сервере:

```bash
# OpenAI ключ
OPENAI_API_KEY=sk-ваш_ключ

# Провайдер
IMAGE_GENERATION_PROVIDER=openai

# Прокси (пример)
OPENAI_PROXY=http://proxy.example.com:8080

# Или с авторизацией
# OPENAI_PROXY=http://username:password@proxy.example.com:8080
```

## Проверка работы

После настройки прокси:

1. Перезапустите сервер
2. Попробуйте сгенерировать изображение
3. В логах должно быть:
   ```
   Using OpenAI DALL-E for image generation
   Image generation completed successfully
   ```

Если видите ошибку региона - прокси не работает, проверьте настройки.

## Важные моменты

1. **Прокси должен поддерживать HTTPS** - OpenAI API использует HTTPS
2. **Прокси должен быть в доступном регионе** - США, Европа, Канада и т.д.
3. **Скорость прокси важна** - медленный прокси замедлит генерацию
4. **Прокси должен быть стабильным** - частые обрывы приведут к ошибкам

## Безопасность

- Не используйте публичные бесплатные прокси для продакшена
- Используйте надежные прокси-сервисы или свой прокси
- Проверяйте логи на наличие ошибок подключения

