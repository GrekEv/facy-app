# Настройка PostgreSQL на Timeweb

## Шаг 1: Создание базы данных в панели Timeweb

### 1.1. Откройте панель Timeweb
- Перейдите на https://timeweb.cloud/
- Войдите в аккаунт

### 1.2. Создайте базу данных
1. В левом меню найдите **"Базы данных"** или **"Databases"**
2. Нажмите **"Создать базу данных"** или **"Заказать"**
3. Выберите:
   - **Тип:** PostgreSQL (рекомендуется PostgreSQL 18)
   - **Регион:** Выберите ближайший (например, Нидерланды)
   - **Конфигурация:** Минимум 1 CPU, 1 GB RAM, 8 GB NVMe

### 1.3. Настройка сети

**Вариант A: Публичный IP (рекомендуется для начала)**
- Нажмите **"+ Публичный IP"**
- Стоимость: ~150 ₽/мес
- **Преимущества:** Простое подключение с любого сервера
- **Недостатки:** Дополнительная стоимость

**Вариант B: Приватная сеть (если сервер и БД в одном проекте)**
- Нажмите **"+ Добавить сеть"**
- Выберите существующую приватную сеть или создайте новую
- Укажите приватный IP (например: 192.168.0.4)
- **Преимущества:** Бесплатно, безопаснее
- **Недостатки:** Работает только внутри приватной сети Timeweb

### 1.4. Дополнительные услуги
- **Бэкапы:** Рекомендуется включить (автоматические резервные копии)
- Остальные опции - по необходимости

### 1.5. Завершите создание
- Нажмите **"Заказать"**
- Дождитесь создания базы данных (обычно 1-2 минуты)

## Шаг 2: Получение данных подключения

После создания базы данных:

1. Откройте созданную базу данных в списке
2. Найдите раздел **"Подключение"** или **"Connection"**
3. Скопируйте данные:
   - **Хост (Host):** например, `postgres-xxx.timeweb.cloud` или IP адрес
   - **Порт (Port):** обычно `5432`
   - **База данных (Database):** имя базы (например, `postgres` или указанное вами)
   - **Пользователь (User):** имя пользователя
   - **Пароль (Password):** пароль (если не помните, можно сбросить)

## Шаг 3: Настройка на сервере

### Автоматически (скрипт)

```bash
ssh root@72.56.85.215
cd ~/facy-app

# Скачайте скрипт
wget https://raw.githubusercontent.com/GrekEv/facy-app/main/setup_timeweb_db.sh
chmod +x setup_timeweb_db.sh
./setup_timeweb_db.sh
```

Скрипт спросит:
- Хост базы данных
- Порт (по умолчанию 5432)
- Имя базы данных
- Пользователь
- Пароль

### Вручную

```bash
ssh root@72.56.85.215
cd ~/facy-app

# Откройте .env для редактирования
nano .env
```

**Удалите старую строку с Yandex Cloud:**
```
DATABASE_URL=postgresql+asyncpg://facy_user:etxX4gk272PdJYH@rc1a-6t9pb3se81b4idf5.mdb.yandexcloud.net:6432/facy_db?ssl=require
```

**Добавьте новую строку для Timeweb:**
```
DATABASE_URL=postgresql+asyncpg://пользователь:пароль@хост:порт/база_данных?ssl=require
```

**Пример:**
```
DATABASE_URL=postgresql+asyncpg://postgres:mypassword@postgres-xxx.timeweb.cloud:5432/postgres?ssl=require
```

**Важно:**
- Формат: `postgresql+asyncpg://` (не просто `postgresql://`)
- Параметр `?ssl=require` обязателен для Timeweb
- Не используйте пробелы в строке

**Сохраните файл:**
- `Ctrl+O` (сохранить)
- `Enter` (подтвердить)
- `Ctrl+X` (выйти)

## Шаг 4: Перезапуск контейнеров

```bash
# Определите команду docker compose
if command -v docker-compose &> /dev/null; then
    COMPOSE="docker-compose"
else
    COMPOSE="docker compose"
fi

# Остановите контейнеры
$COMPOSE -f docker-compose.prod.yml down

# Запустите заново
$COMPOSE -f docker-compose.prod.yml up -d

# Подождите 30 секунд
sleep 30

# Проверьте статус
$COMPOSE -f docker-compose.prod.yml ps

# Проверьте подключение к БД
curl http://localhost:8000/api/health
```

## Шаг 5: Проверка подключения

```bash
# На сервере
curl http://localhost:8000/api/health

# Должен вернуть JSON с информацией о базе данных:
# {
#   "status": "ok",
#   "database": "connected" или "ok"
# }
```

Если видите ошибку подключения:
1. Проверьте правильность данных в `.env`
2. Убедитесь, что база данных запущена в панели Timeweb
3. Проверьте firewall - порт 5432 должен быть открыт
4. Если используете приватную сеть - убедитесь, что сервер в той же сети

## Важные моменты

### Публичный IP vs Приватная сеть

**Публичный IP:**
- ✅ Работает с любого сервера
- ✅ Проще настроить
- ❌ Дополнительная стоимость (~150 ₽/мес)
- ❌ Менее безопасно (нужно настроить firewall)

**Приватная сеть:**
- ✅ Бесплатно
- ✅ Безопаснее (недоступна из интернета)
- ❌ Работает только внутри Timeweb
- ❌ Нужно, чтобы сервер и БД были в одной сети

### Рекомендация

Для начала используйте **публичный IP** - это проще настроить. Позже можно переключиться на приватную сеть для экономии и безопасности.

## Альтернатива: SQLite

Если не хотите настраивать PostgreSQL, можно использовать SQLite (локальная база данных):

```bash
ssh root@72.56.85.215
cd ~/facy-app

# Удалите DATABASE_URL из .env
sed -i '/^DATABASE_URL=/d' .env

# Создайте директорию для БД
mkdir -p data

# Перезапустите
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d
```

SQLite создастся автоматически в `data/app.db`.

