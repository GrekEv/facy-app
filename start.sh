#!/bin/bash

# ––∫—––ø—Ç –∑–∞–ø—É—–∫–∞ DeepFace AI –ø—––ª–æ–∂–µ–Ω–—

echo " –ó–∞–ø—É—–∫ DeepFace AI..."

# –—–æ–≤–µ—–∫–∞ –≤–——Ç—É–∞–ª—–Ω–æ––æ –æ–∫——É–∂–µ–Ω–—
if [ ! -d "venv" ]; then
    echo "¶ ––æ–∑–¥–∞–Ω––µ –≤–——Ç—É–∞–ª—–Ω–æ––æ –æ–∫——É–∂–µ–Ω–—..."
    python3 -m venv venv
fi

# ––∫—Ç––≤–∞—Ü–— –≤–——Ç—É–∞–ª—–Ω–æ––æ –æ–∫——É–∂–µ–Ω–—
echo " ––∫—Ç––≤–∞—Ü–— –≤–——Ç—É–∞–ª—–Ω–æ––æ –æ–∫——É–∂–µ–Ω–—..."
source venv/bin/activate

# –£——Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–—––º–æ——Ç–µ–π
echo " –£——Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–—––º–æ——Ç–µ–π..."
pip install -r requirements.txt

# –—–æ–≤–µ—–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    echo "  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo " ––æ–∑–¥–∞–Ω––µ .env ––∑ .env.example..."
    cp .env.example .env
    echo ""
    echo "ó –––ñ––û: –û—Ç—–µ–¥–∞–∫—Ç–——É–π—Ç–µ —Ñ–∞–π–ª .env – —É–∫–∞–∂–—Ç–µ –≤–∞—à BOT_TOKEN!"
    echo "ó ––æ–ª—É—á–—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram"
    echo ""
    read -p "––∞–∂–º–—Ç–µ Enter –ø–æ—–ª–µ —–µ–¥–∞–∫—Ç–—–æ–≤–∞–Ω–— .env..."
fi

# –ó–∞–ø—É—–∫ API —–µ—–≤–µ—–∞ –≤ —Ñ–æ–Ω–µ
echo " –ó–∞–ø—É—–∫ API —–µ—–≤–µ—–∞..."
python run_api.py &
API_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—–∫–∞ API
sleep 3

# –ó–∞–ø—É—–∫ ––æ—Ç–∞
echo "§ñ –ó–∞–ø—É—–∫ Telegram ––æ—Ç–∞..."
python main.py &
BOT_PID=$!

echo ""
echo " –—––ª–æ–∂–µ–Ω––µ –∑–∞–ø—É—–µ–Ω–æ!"
echo " API —–µ—–≤–µ—: http://localhost:8000"
echo "§ñ Telegram ––æ—Ç: –∞–∫—Ç––≤–µ–Ω"
echo ""
echo "––ª— –æ——Ç–∞–Ω–æ–≤–∫– –Ω–∞–∂–º–—Ç–µ Ctrl+C"
echo ""

# –û–—–∞––æ—Ç–∫–∞ –æ——Ç–∞–Ω–æ–≤–∫–
trap "echo 'õë –û——Ç–∞–Ω–æ–≤–∫–∞ –ø—––ª–æ–∂–µ–Ω–—...'; kill $API_PID $BOT_PID; exit" INT TERM

# –û–∂––¥–∞–Ω––µ
wait

