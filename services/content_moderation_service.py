"""–°–µ—Ä–≤–∏—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
import re
import logging
from typing import Dict, Tuple

logger = logging.getLogger(__name__)


class ContentModerationService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
    
    # –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ –∏ —Ñ—Ä–∞–∑ (NSFW, –Ω–∞—Å–∏–ª–∏–µ, –∏ —Ç.–¥.)
    BANNED_KEYWORDS = [
        'porn', '–ø–æ—Ä–Ω–æ', 'xxx', 'sex', '—Å–µ–∫—Å', 'nude', '–≥–æ–ª—ã–π', '–≥–æ–ª–∞—è',
        'nsfw', '18+', 'adult', '—ç—Ä–æ—Ç–∏–∫–∞', 'erotic', 'naked', '–æ–±–Ω–∞–∂–µ–Ω–Ω',
        'violence', '–Ω–∞—Å–∏–ª–∏–µ', 'blood', '–∫—Ä–æ–≤—å', 'weapon', '–æ—Ä—É–∂–∏–µ',
        'drugs', '–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏', 'hate', '–Ω–µ–Ω–∞–≤–∏—Å—Ç—å'
    ]
    
    # –°–ø–∏—Å–æ–∫ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    SUSPICIOUS_KEYWORDS = [
        'underwear', '–±–µ–ª—å–µ', 'bikini', '–±–∏–∫–∏–Ω–∏', 'swimsuit', '–∫—É–ø–∞–ª—å–Ω–∏–∫',
        'body', '—Ç–µ–ª–æ', 'skin', '–∫–æ–∂–∞'
    ]
    
    def __init__(self):
        self.enabled = True
    
    def check_text_content(self, text: str) -> Tuple[bool, str]:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å
        
        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ, –ø—Ä–∏—á–∏–Ω–∞_–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)
        """
        if not text:
            return True, ""
        
        text_lower = text.lower()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
        for keyword in self.BANNED_KEYWORDS:
            if keyword in text_lower:
                logger.warning(f"Blocked prompt with banned keyword: {keyword}")
                return False, f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: '{keyword}'"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
        suspicious_count = sum(1 for keyword in self.SUSPICIOUS_KEYWORDS if keyword in text_lower)
        if suspicious_count >= 2:
            logger.warning(f"Blocked prompt with suspicious keywords count: {suspicious_count}")
            return False, "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ö–æ–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        if self._check_obfuscation(text_lower):
            return False, "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –æ–±—Ö–æ–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
        
        return True, ""
    
    def _check_obfuscation(self, text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ö–æ–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∑–∞–º–µ–Ω–∞ –±—É–∫–≤, –ø—Ä–æ–±–µ–ª—ã –∏ —Ç.–¥.)
        """
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏
        text_no_spaces = re.sub(r'\s+', '', text)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
        for keyword in self.BANNED_KEYWORDS:
            if keyword in text_no_spaces:
                return True
        
        return False
    
    def get_content_policy(self) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        """
        return """
üîí <b>–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</b>

<b>–ó–∞–ø—Ä–µ—â–µ–Ω–æ:</b>
‚ùå NSFW –∫–æ–Ω—Ç–µ–Ω—Ç (18+, —ç—Ä–æ—Ç–∏–∫–∞, –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—è)
‚ùå –ù–∞—Å–∏–ª–∏–µ, –∂–µ—Å—Ç–æ–∫–æ—Å—Ç—å
‚ùå –ù–∞—Ä–∫–æ—Ç–∏–∫–∏ –∏ –æ—Ä—É–∂–∏–µ
‚ùå –†–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏
‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–ø—Ñ–µ–π–∫–æ–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è

<b>–†–∞–∑—Ä–µ—à–µ–Ω–æ:</b>
‚úÖ –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–ø–µ–π–∑–∞–∂–∏, –æ–±—ä–µ–∫—Ç—ã, —Ñ—ç–Ω—Ç–µ–∑–∏)
‚úÖ –ü–æ—Ä—Ç—Ä–µ—Ç—ã (–±–µ–∑ NSFW)
‚úÖ –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç—ã
‚úÖ –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
‚úÖ –î–∏–ø—Ñ–µ–π–∫–∏ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –ª–∏—Ü–æ–º –∏–ª–∏ —Å —Å–æ–≥–ª–∞—Å–∏—è

<b>–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π:</b>
‚ö†Ô∏è –ü–µ—Ä–≤–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
üö´ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
üì¢ –°–µ—Ä—å–µ–∑–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è - –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã

<i>–ò—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞.</i>
"""
    
    def check_image_safety(self, image_url: str) -> Dict:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
        
        –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å:
        - Google Cloud Vision API
        - AWS Rekognition
        - Azure Content Moderator
        
        Args:
            image_url: URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
        """
        # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        return {
            "safe": True,
            "confidence": 0.95,
            "labels": []
        }
    
    def log_violation(self, user_id: int, content_type: str, content: str, reason: str):
        """
        –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        """
        logger.warning(
            f"Content policy violation | "
            f"User: {user_id} | "
            f"Type: {content_type} | "
            f"Reason: {reason} | "
            f"Content: {content[:100]}"
        )


content_moderation = ContentModerationService()

